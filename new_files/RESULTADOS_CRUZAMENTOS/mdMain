Attribute VB_Name = "mdMain"
Public Sub Corrigir_Corrompidos(strPath As String)
    Dim FSO         As Object 'Scripting.FileSystemObject'
    Dim fItem       As Object 'Scripting.File'
    Dim wb          As Workbook
    Dim iCounter    As Integer
    Dim Result      As Integer
    Dim iCell       As Range, ws As Worksheet, iCellRow As Long
    Dim LastRow     As Long
    
    Set FSO = VBA.CreateObject("Scripting.FileSystemObject")
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    
    If _
         Not MsgBox("O algorítimo de correção de arquivos precisa ser executado antes de atualizar os dados, deseja continuar?", vbYesNo + vbQuestion) = vbYes Then Exit Sub
    
    Application.StatusBar = "Arquivos sendo corrigidos, por favor aguarde..."
    
    For Each fItem In FSO.GetFolder(strPath).Files
        If VBA.Right(fItem.Name, 3) = "txt" Then fItem.Delete
    Next fItem
    
    For Each fItem In FSO.GetFolder(strPath).Files
        iCounter = iCounter + 1
        Set wb = Application.Workbooks.Open(fItem.Path)
        Set ws = wb.Sheets(1)
        
        iCellRow = 2
        Do While Not ws.Range("G" & iCellRow) = ""
            ws.Range("H" & iCellRow).FormulaR1C1 = "=RC[-1]&"""""
            iCellRow = iCellRow + 1
        Loop
        
        wb.SaveAs strPath & "NEW" & iCounter
        wb.Close False
        Set wb = Nothing
        Set ws = Nothing
    Next fItem
    
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
   
    
    MsgBox "Arquivos Corrigidos, as consultas serão atualizadas depois desta mensagem.", vbInformation
    
    Application.StatusBar = "Atualizando suas consultas..."
    ThisWorkbook.RefreshAll
    
    Application.StatusBar = "Pronto!"
End Sub
